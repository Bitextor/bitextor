#!__ENV__ __PYTHON__

#
# 1. Leer .lettr y cargarlo en memoria
# 2. Leer .ridx e ir haciendo distancia de edicion
# 3. Con el porcentaje de parecido anterior y el nuevo se realiza:
#      nuevo_porcentaje = ant_porcentaje * dist_porcentaje
#    donde:
#      dist_porcentaje = longitud(raspa1) / (longitud(raspa1) + dist)
# 4. Se muestran los 10 documentos con los porcentajes actualizados
#
# Formato final del documento:
# num_doc_lang1    [num_doc_lang2:frequency]+
#
# Genera .ridx -> reverse index
#

import sys
from operator import itemgetter
import Levenshtein

def rellenarDocumentos(fich, documentos):
  file = open(fich, "r")
  contador = 1
  for i in file:
    campos = i.split("\t")
    if len(campos) == 6:
      documentos[contador] = campos[5]
    contador += 1
  file.close()

if len(sys.argv) == 3:
  index = {}
  documentos = {}
  fich = sys.argv[1]
  ridx = sys.argv[2]
  rellenarDocumentos(fich, documentos)

  file = open(ridx, "r")
  for i in file:
    campos = i.split("\t")
    longitud = len(documentos[int(campos[0])])
    parecidos = {}
    cadena = str(campos[0])
    for j in range(1,len(campos)-1):
      doc = campos[j].split(":")
      if float(doc[1]) > 0.10:
        dist = Levenshtein.distance(documentos[int(campos[0])],documentos[int(doc[0])])
        port = longitud / float(longitud + dist)
	##port = float((min(len(documentos[int(campos[0])]),len(documentos[int(doc[0])]))/float(max(len(documentos[int(campos[0])]),len(documentos[int(doc[0])]))))*(longitud / float(longitud + dist)))
        new_per = (float(doc[1]) + port)/2.0
        #new_per = port
        #new_per = float(doc[1]) * port
        parecidos[doc[0]] = new_per
    parecidos = sorted(parecidos.items(), key=itemgetter(1), reverse=True)
    for k in parecidos:
      cadena += "\t" + str(k[0]) + ":" + str(k[1])
    print cadena

else:
  error = "USAGE: " + sys.argv[0] + " file index\n"
  error += "WHERE\n"
  error += "   file   file with extension .lettr (language encoded and typed data with \'raspa\' -HTML skeleton-)\n"
  error += "   index  file with extension .ridx (reverse index)\n"
  sys.exit(error)

